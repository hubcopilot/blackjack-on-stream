<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackjack — Twitch Overlay</title>
<script src="https://cdn.jsdelivr.net/npm/tmi.js/dist/tmi.min.js"></script>
<style>
  :root{
    --bg:#0c0f14; --panel:#121826; --accent:#20d3a6; --muted:#9aa4b2; --text:#eef2f7;
    --good:#45e39a; --bad:#ff6b6b; --warn:#ffb454;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0c0f14;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  .wrap{max-width:1400px;margin:auto;padding:12px;position:relative}
  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .topbar input{width:200px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,.08);background:#0f1422;color:var(--text)}
  .badge{background:#1a233c;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;font-size:12px}
  .btn{background:var(--accent);color:#041a16;border:none;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.alt{background:#253152;color:#dfe7f1}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .panel{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .table{background:#0f1527;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;position:relative;overflow:hidden}
  .dealer{margin-bottom:10px;padding:8px;border:1px dashed rgba(255,255,255,.12);border-radius:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .handbox{flex:1 1 260px;min-width:240px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px}
  .handbox.active{box-shadow:0 0 0 2px var(--accent) inset}
  .handhead{display:flex;justify-content:space-between;margin-bottom:6px}
  .name{font-weight:800}
  .cards{display:flex;gap:6px;flex-wrap:wrap;min-height:90px}
  .card{width:60px;height:88px;border-radius:8px;background:#12203a;border:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;position:relative}
  .card .sm{position:absolute;top:6px;left:8px;font-size:14px}
  .card.red{color:#ff8a8a}
  .card.hidden{background:linear-gradient(135deg,#1d2a52,#0f1732);border-color:#1b2446}
  .status{font-size:13px;color:var(--muted);min-height:18px}
  .result.win{color:var(--good)} .result.lose{color:var(--bad)} .result.push{color:var(--warn)}
  .list{max-height:220px;overflow:auto;font-size:14px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:#0f1422}
  .line{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06)}
  .chat{max-height:320px;overflow:auto;background:#0f1422;border-radius:10px;border:1px solid rgba(255,255,255,.08);padding:6px}
  .chat .msg{font-size:13px;color:#d1d7e6;border-bottom:1px solid rgba(255,255,255,.06);padding:3px 2px}
  .flash{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(32,211,166,0.95);color:#041a16;padding:20px 40px;border-radius:16px;font-size:24px;font-weight:800;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:100;max-width:90%;text-align:center}
  .flash.show{opacity:1;}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <input id="channelInput" type="text" placeholder="Twitch channel (e.g. ryaah)">
    <button id="connectBtn" class="btn">Connect</button>
    <span class="badge" id="conn">Not connected</span>
    <button id="modeBtn" class="btn alt">Mode: Turn-Based</button>
    <button id="startBtn" class="btn">Start Round</button>
  </div>

  <div class="layout">
    <div id="tablePanel" class="table panel">
      <div class="dealer">
        <div class="row" style="justify-content:space-between;">
          <div><b>Dealer</b> <span id="dealerScore">-</span></div>
          <div id="roundInfo">Waiting for queue…</div>
        </div>
        <div class="cards" id="dealerCards"></div>
      </div>
      <div id="playersRow" class="row"></div>
      <div id="flashMsg" class="flash"></div>
    </div>

    <div>
      <div class="panel"><h2>Queue</h2><div id="queueList" class="list"></div></div>
      <div class="panel"><h2>Joins</h2><div id="joinList" class="list"></div></div>
      <div class="panel"><h2>Chat</h2><div id="chatBox" class="chat"></div></div>
    </div>
  </div>
</div>

<script>
let client=null,shoe=[],dealer={},inRound=false;
let activePlayers=[],queue=[];
let playMode='turn'; // turn | all
let turn=-1;

const $=id=>document.getElementById(id);

function flashMessage(msg){const f=$('flashMsg');f.textContent=msg;f.classList.add('show');setTimeout(()=>f.classList.remove('show'),3000);}

/* ===== Cards ===== */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
function buildShoe(){const r=['A','2','3','4','5','6','7','8','9','10','J','Q','K'],s=['♠','♥','♦','♣'];shoe=[];for(let d=0;d<6;d++){for(const rr of r){for(const ss of s)shoe.push({r:rr,s:ss});}}shuffle(shoe);}
function draw(){if(shoe.length===0)buildShoe();return shoe.pop();}
function bestValue(cards){let t=0,a=0;for(const c of cards){if(c.r==='A'){a++;t+=11;}else if(['10','J','Q','K'].includes(c.r))t+=10;else t+=+c.r;}while(t>21&&a>0){t-=10;a--;}return t;}
function isSoft(cards){let t=0,a=0;for(const c of cards){if(c.r==='A'){a++;t+=11;}else if(['10','J','Q','K'].includes(c.r))t+=10;else t+=+c.r;}while(t>21&&a>0){t-=10;a--;}return a>0;}
function cardEl(c,h=false){const d=document.createElement('div');d.className='card'+((c?.s==='♥'||c?.s==='♦')?' red':'');if(h){d.classList.add('hidden');return d;}const sm=document.createElement('div');sm.className='sm';sm.textContent=c.r;d.appendChild(sm);const big=document.createElement('div');big.textContent=c.s;d.appendChild(big);return d;}

/* ===== Render ===== */
function render(){
  const dc=$('dealerCards');dc.innerHTML='';
  dealer.hand?.forEach((c,i)=>dc.appendChild(cardEl(c,!dealer.reveal && i===1)));
  $('dealerScore').textContent=dealer.reveal?bestValue(dealer.hand):(dealer.hand[0]?bestValue([dealer.hand[0]]):'-');

  const row=$('playersRow');row.innerHTML='';
  activePlayers.forEach((p,i)=>{
    const box=document.createElement('div');box.className='handbox'; if(playMode==='turn'&&i===turn) box.classList.add('active');
    const head=document.createElement('div');head.className='handhead';head.innerHTML=`<span class="name">${p.name}</span>`;
    const cards=document.createElement('div');cards.className='cards';(p.hand||[]).forEach(c=>cards.appendChild(cardEl(c)));
    const status=document.createElement('div');status.className='status';
    if(p.result) status.innerHTML=`<span class="result ${p.result.type}">${p.result.text}</span>`;
    else if(playMode==='turn'&&i===turn) status.textContent='Your turn — !hit / !stand';
    else if(playMode==='all') status.textContent=p.done?'Done':'Playing…';
    box.append(head,cards,status);
    row.appendChild(box);
  });

  $('queueList').innerHTML=queue.length?queue.map((n,i)=>`<div class="line">${i+1}. ${n}</div>`).join(''):'<div class="line">Queue empty</div>';
}

/* ===== Queue ===== */
function joinCommand(n){if(activePlayers.find(p=>p.name===n)||queue.includes(n))return;queue.push(n);render();}
function leaveCommand(n){queue=queue.filter(x=>x!==n);render();}

/* ===== Round ===== */
function startRound(){
  if(inRound||queue.length===0)return;
  activePlayers=queue.map(u=>({name:u,hand:[draw(),draw()],result:null,done:false}));
  queue=[];
  dealer={hand:[draw(),draw()],reveal:false};
  inRound=true; turn=0; $('roundInfo').textContent=`Round started with ${activePlayers.length} players`;render();
}

function handleHit(n){
  if(!inRound)return;
  const idx=playMode==='turn'?turn:activePlayers.findIndex(p=>p.name===n&&!p.done);
  if(idx<0)return;
  const p=activePlayers[idx];p.hand.push(draw());
  if(bestValue(p.hand)>21){p.result={type:'lose',text:'Busted'};p.done=true;}
  render();
}
function handleStand(n){
  if(!inRound)return;
  const idx=playMode==='turn'?turn:activePlayers.findIndex(p=>p.name===n&&!p.done);
  if(idx<0)return;
  const p=activePlayers[idx];p.done=true;p.result={type:'push',text:'Stood'};render();
}

/* ===== Dealer ===== */
function dealerPhase(){
  dealer.reveal=true;let v=bestValue(dealer.hand);
  while(v<17||(v===17&&isSoft(dealer.hand))){if(v===17&&isSoft(dealer.hand))break;dealer.hand.push(draw());v=bestValue(dealer.hand);}
  const dVal=bestValue(dealer.hand);
  activePlayers.forEach(p=>{
    if(!p.result||p.result.type==='push'){const vP=bestValue(p.hand);
      if(vP>21)p.result={type:'lose',text:'Busted'};
      else if(dVal>21||vP>dVal)p.result={type:'win',text:'Win'};
      else if(vP<dVal)p.result={type:'lose',text:'Lost'};
      else p.result={type:'push',text:'Push'};
    }
  });
  inRound=false;render();
  setTimeout(()=>{ $('roundInfo').textContent='Auto-starting next round…'; render(); setTimeout(startRound,3000); },3000);
}

/* ===== Twitch ===== */
function connectTwitch(ch){
  try{if(client)client.disconnect();}catch(_){}
  client=new tmi.Client({connection:{secure:true,reconnect:true},channels:[ch]});
  client.connect().then(()=>$('conn').textContent=`Connected: ${ch}`);
  client.on('message',(chan,tags,msg,self)=>{
    if(self)return;const n=tags['display-name']||tags.username;const t=msg.trim().toLowerCase();
    $('chatBox').innerHTML+=`<div class="msg"><b>${n}:</b> ${msg}</div>`;
    if(t==='!join')joinCommand(n);
    if(t==='!leave')leaveCommand(n);
    if(t==='!hit')handleHit(n);
    if(t==='!stand')handleStand(n);
    if(t==='!deal')dealerPhase();
  });
}

/* ===== Controls ===== */
$('connectBtn').onclick=()=>{const ch=$('channelInput').value.trim();if(ch)connectTwitch(ch);};
$('startBtn').onclick=startRound;
$('modeBtn').onclick=()=>{playMode=playMode==='turn'?'all':'turn';$('modeBtn').textContent='Mode: '+(playMode==='turn'?'Turn-Based':'All-at-Once');};

buildShoe();render();
</script>
</body>
</html>
